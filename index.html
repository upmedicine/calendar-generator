<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendario de Estudio</title>
  <style>
    :root{
      --primary:#2A98A5; /* teal */
      --accent:#FAA84A;  /* orange */
      --bg:#f7fafb;
      --day-bg:#ffffff;
      --text:#102a43;
      --muted:#627d98;
      --border:#d9e2ec;
      --chip-text:#0b1f2a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg); color: var(--text);
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter: blur(6px);
      background: color-mix(in oklab, white 70%, var(--primary));
      border-bottom: 2px solid var(--primary);
      padding: 14px 18px; display:flex; align-items:center; justify-content:space-between;
    }
    header h1{ margin:0; font-size: clamp(18px, 2.2vw, 28px); letter-spacing: .3px; }
    header .meta{ font-size: 14px; color: var(--muted); }
    main{ max-width: 1100px; margin: 24px auto; padding: 0 16px 48px; }

    .notice{ background: #fff; border:1px solid var(--border); padding:14px 16px; border-left:4px solid var(--accent); border-radius:12px; margin:16px 0; }

    .legend{ display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 20px; align-items:center }
    .legend .item{ display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted) }
    .legend .swatch{ width:14px; height:14px; border-radius:4px; border:1px solid #0001 }

    .month{ margin: 18px 0 28px; border:1px solid var(--border); border-radius:16px; overflow:hidden; background:#fff; box-shadow: 0 6px 18px -12px #0003 }
    .month-header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 10px 14px; background: linear-gradient(0deg, #fff, color-mix(in oklab, white 75%, var(--primary)));
      border-bottom:1px solid var(--border);
    }
    .month-title{ font-weight:700; color: var(--primary); letter-spacing:.3px }
    .weekdays, .days{ display:grid; grid-template-columns: repeat(7, 1fr); }
    .weekdays div{ text-align:center; padding:10px 4px; font-size:12px; color:#2b2b2b; background: color-mix(in oklab, white 92%, var(--primary)); font-weight:600 }

    .day{
      min-height: 120px; border-top:1px solid var(--border); border-right:1px solid var(--border); background: var(--day-bg);
      padding:8px; display:flex; flex-direction:column; gap:6px;
    }
    .day:nth-child(7n){ border-right:none }
    .date{ font-size:12px; color: var(--muted); font-weight:700 }

    .chip{ display:inline-flex; align-items:center; gap:6px; padding:5px 8px; border-radius:999px; font-size:11px; line-height:1.1; font-weight:700; border:1px solid #0002; max-width:100%; }
    .chip .topic{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .chip .area{ opacity:.85; font-weight:800 }

    .today{ outline:2px solid var(--accent); outline-offset:-2px; }

    @media (max-width: 720px){
      .day{ min-height: 140px }
    }
  </style>
</head>
<body>
  <header>
    <h1>Calendario de Estudio</h1>
    <div class="meta" id="meta"></div>
  </header>
  <main>
    <div id="messages" class="notice" hidden></div>
    <section id="legend" class="legend"></section>
    <section id="calendars"></section>
  </main>

<script>
(async function(){
  const params = new URLSearchParams(location.search);
  const startParam = params.get('startDate'); // DD-MM-YYYY
  const totalDaysParam = params.get('totalDays');

  const messages = document.getElementById('messages');
  const calendars = document.getElementById('calendars');
  const legend = document.getElementById('legend');
  const meta = document.getElementById('meta');

  const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const WEEKDAYS = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom']; // Monday-first

  function showMessage(text){ messages.hidden = false; messages.textContent = text; }

  function parseDDMMYYYY(s){
    const m = /^(\d{2})-(\d{2})-(\d{4})$/.exec(s || '');
    if(!m) return null;
    const [_, dd, mm, yyyy] = m;
    const d = new Date(Number(yyyy), Number(mm)-1, Number(dd));
    // validate round-trip
    if(d.getFullYear()!=Number(yyyy) || d.getMonth()!=Number(mm)-1 || d.getDate()!=Number(dd)) return null;
    return d;
  }

  function formatDDMMYYYY(d){
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${dd}-${mm}-${yyyy}`;
  }

  // Ensure params
  const startDate = parseDDMMYYYY(startParam);
  const totalDays = Number(totalDaysParam);

  if(!startDate || !Number.isFinite(totalDays) || totalDays <= 0){
    showMessage('Agrega los parámetros en la URL: ?startDate=DD-MM-YYYY&totalDays=N');
    return;
  }

  if(totalDays < 4){
    showMessage('totalDays debe ser mayor o igual a 4 (los últimos 4 días son de Simulador/Repaso).');
    return;
  }

  meta.textContent = `Inicio: ${formatDDMMYYYY(startDate)} · Días: ${totalDays}`;

  let topics;
  try {
    const res = await fetch('study-topics.json', {cache:'no-store'});
    if(!res.ok) throw new Error('No se pudo cargar study-topics.json');
    topics = await res.json();
  } catch(err){
    showMessage('Error al cargar study-topics.json. Asegúrate de colocarlo junto a este archivo.');
    console.error(err);
    return;
  }

  // Separate last four "Simulador / repaso general" (ensure they are the last four)
  const simuladorLabel = 'Simulador / repaso general';
  const lastFour = topics.slice(-4);
  const allLastAreSim = lastFour.every(t=>t.topic.trim().toLowerCase() === simuladorLabel.toLowerCase());
  if(!allLastAreSim){
    // fallback: pick last four occurrences
    const idxs = topics.map((t,i)=> t.topic.trim().toLowerCase() === simuladorLabel.toLowerCase() ? i : -1).filter(i=>i>=0);
    topics = topics.filter((_,i)=> !idxs.slice(-4).includes(i)).concat(idxs.slice(-4).map(i=> ({...topics[i]})));
  }

  const simDays = topics.slice(-4);
  const otherTopics = topics.slice(0, -4);

  // Distribute otherTopics across (totalDays - 4) days as evenly as possible
  const studyDays = totalDays - 4;
  const R = otherTopics.length;
  const base = Math.floor(R / studyDays);
  const extra = R % studyDays;

  const schedule = [];
  let cursor = 0;
  for(let i=0;i<studyDays;i++){
    const count = base + (i < extra ? 1 : 0);
    const chunk = otherTopics.slice(cursor, cursor + count);
    cursor += count;
    schedule.push(chunk);
  }
  // Append the four single-topic days
  for(const s of simDays){ schedule.push([s]); }

  // Build date range
  const days = [];
  for(let i=0;i<totalDays;i++){
    const d = new Date(startDate); d.setDate(d.getDate()+i);
    days.push({ date: d, items: schedule[i] || [] });
  }

  // Map thematic-area => color (distinct + accessible)
  const uniqueAreas = Array.from(new Set(topics.map(t=>t['thematic-area'])));
  const palette = [
    '#2A98A5','#FAA84A','#6A7FDB','#49A078','#D9777F','#9B59B6','#E67E22','#16A085','#C0392B','#2ECC71','#2980B9','#F39C12'
  ];
  const areaColor = new Map();
  uniqueAreas.forEach((area, idx)=>{
    const color = palette[idx % palette.length];
    areaColor.set(area, color);
  });

  // Render legend
  for(const area of uniqueAreas){
    const item = document.createElement('div'); item.className = 'item';
    const sw = document.createElement('span'); sw.className = 'swatch'; sw.style.background = areaColor.get(area);
    const label = document.createElement('span'); label.textContent = area;
    item.append(sw, label); legend.appendChild(item);
  }

  // Group days by month
  const byMonth = new Map();
  for(const entry of days){
    const key = `${entry.date.getFullYear()}-${entry.date.getMonth()}`;
    if(!byMonth.has(key)) byMonth.set(key, []);
    byMonth.get(key).push(entry);
  }

  // Utility: first weekday offset (Mon=0..Sun=6)
  function weekdayMon0(date){
    let w = date.getDay(); // 0=Sun..6=Sat
    return (w+6)%7; // 0=Mon..6=Sun
  }

  // Render each month as a calendar table
  const todayStr = formatDDMMYYYY(new Date());

  for(const [key, entries] of Array.from(byMonth.entries()).sort((a,b)=> a[0] < b[0] ? -1 : 1)){
    const monthDate = new Date(entries[0].date.getFullYear(), entries[0].date.getMonth(), 1);
    const year = monthDate.getFullYear();
    const month = monthDate.getMonth();

    const monthWrap = document.createElement('section'); monthWrap.className='month';

    const header = document.createElement('div'); header.className = 'month-header';
    const title = document.createElement('div'); title.className = 'month-title';
    title.textContent = `${MONTHS[month]} ${year}`;
    header.appendChild(title);
    monthWrap.appendChild(header);

    const weekdaysRow = document.createElement('div'); weekdaysRow.className='weekdays';
    WEEKDAYS.forEach(w=>{ const el = document.createElement('div'); el.textContent = w; weekdaysRow.appendChild(el); });
    monthWrap.appendChild(weekdaysRow);

    const grid = document.createElement('div'); grid.className='days';

    // calculate leading empty cells (from first day of month to Monday)
    const firstOfMonth = new Date(year, month, 1);
    const lead = weekdayMon0(firstOfMonth);
    for(let i=0;i<lead;i++){ grid.appendChild(document.createElement('div')); }

    // fill days of month
    const daysInMonth = new Date(year, month+1, 0).getDate();

    for(let day=1; day<=daysInMonth; day++){
      const cell = document.createElement('div'); cell.className='day';
      const thisDate = new Date(year, month, day);
      const dateSpan = document.createElement('div'); dateSpan.className='date'; dateSpan.textContent = String(day);
      cell.appendChild(dateSpan);

      const thisStr = formatDDMMYYYY(thisDate);
      const inStudy = entries.find(e=> formatDDMMYYYY(e.date) === thisStr);
      if(inStudy){
        for(const item of inStudy.items){
          const chip = document.createElement('div'); chip.className='chip';
          const bg = areaColor.get(item['thematic-area']);
          chip.style.background = bg;
          chip.style.color = bestTextColor(bg);
          chip.style.borderColor = '#0002';

          const area = document.createElement('span'); area.className='area'; area.textContent = shortArea(item['thematic-area']);
          const topic = document.createElement('span'); topic.className='topic'; topic.textContent = item.topic;
          chip.append(area, topic);
          cell.appendChild(chip);
        }
      }

      if(thisStr === todayStr){ cell.classList.add('today'); }
      grid.appendChild(cell);
    }

    monthWrap.appendChild(grid);
    calendars.appendChild(monthWrap);
  }

  function shortArea(area){
    // keep it short but readable in chips
    const map = {
      'Infectología II + Urgencias': 'Inf II + Urg',
      'Gastroenterología II + Misceláneos': 'Gastro II + Misc',
      'Neuro, Geriatría y Farmacología': 'Neuro/Ger/Farm',
      'Salud Pública + Epidemiología': 'SP + Epi',
      'Misceláneos + Reforzamiento': 'Misc + Ref'
    };
    return map[area] || area;
  }

  function bestTextColor(hex){
    // contrast check (YIQ)
    const {r,g,b} = hexToRgb(hex);
    const yiq = (r*299 + g*587 + b*114)/1000;
    return yiq >= 140 ? '#0b1f2a' : '#ffffff';
  }
  function hexToRgb(hex){
    const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return m ? { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) } : {r:0,g:0,b:0};
  }
})();
</script>
</body>
</html>